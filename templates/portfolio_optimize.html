{% extends 'base.html' %}

{% block title %}Optimize Portfolio: {{ portfolio.name }}{% endblock %}

{% block content %}
<div class="container mt-4">
    <div class="d-flex justify-content-between align-items-center mb-4">
        <h1>Optimize: {{ portfolio.name }}</h1>
        <div>
            <a href="{{ url_for('portfolio_detail', portfolio_id=portfolio.id) }}" class="btn btn-secondary">
                <i class="fas fa-arrow-left"></i> Back to Portfolio
            </a>
        </div>
    </div>

    <div class="row">
        <div class="col-md-8">
            <div class="card mb-4">
                <div class="card-header bg-primary text-white">
                    <h5 class="card-title mb-0">Portfolio Optimization</h5>
                </div>
                <div class="card-body">
                    <p>Optimize your portfolio to achieve better risk-adjusted returns based on your investment preferences and constraints.</p>

                    <form method="POST">
                        <div class="row mb-4">
                            <div class="col-md-6">
                                <div class="form-group mb-3">
                                    <label for="min_return">Minimum Expected Return (%)</label>
                                    <input type="number" step="0.1" min="0" max="50" class="form-control" id="min_return" name="min_return" value="8.0">
                                    <small class="form-text text-muted">
                                        Target minimum annual return for your portfolio.
                                    </small>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="form-group mb-3">
                                    <label for="max_risk">Maximum Risk (%)</label>
                                    <input type="number" step="0.1" min="0" max="50" class="form-control" id="max_risk" name="max_risk" value="15.0">
                                    <small class="form-text text-muted">
                                        Maximum annual volatility you're willing to accept.
                                    </small>
                                </div>
                            </div>
                        </div>

                        <div class="row mb-4">
                            <div class="col-12">
                                <h5>Asset Allocation Targets</h5>
                                <div class="alert alert-info">
                                    <i class="fas fa-info-circle me-2"></i>
                                    The optimizer will attempt to meet your target allocations while maximizing the risk-adjusted return.
                                </div>
                                
                                <div class="row mb-3">
                                    <div class="col-md-6">
                                        <div class="form-group">
                                            <label for="equity_target">Equity (%)</label>
                                            <input type="number" step="1" min="0" max="100" class="form-control" id="equity_target" name="equity_target" value="60">
                                        </div>
                                    </div>
                                    <div class="col-md-6">
                                        <div class="form-group">
                                            <label for="fixed_income_target">Fixed Income (%)</label>
                                            <input type="number" step="1" min="0" max="100" class="form-control" id="fixed_income_target" name="fixed_income_target" value="25">
                                        </div>
                                    </div>
                                </div>
                                
                                <div class="row">
                                    <div class="col-md-6">
                                        <div class="form-group">
                                            <label for="cash_target">Cash (%)</label>
                                            <input type="number" step="1" min="0" max="100" class="form-control" id="cash_target" name="cash_target" value="10">
                                        </div>
                                    </div>
                                    <div class="col-md-6">
                                        <div class="form-group">
                                            <label for="alternative_target">Alternative (%)</label>
                                            <input type="number" step="1" min="0" max="100" class="form-control" id="alternative_target" name="alternative_target" value="5">
                                        </div>
                                    </div>
                                </div>
                                
                                <div class="form-text text-muted text-center mt-2" id="allocation-sum">
                                    Total: 100%
                                </div>
                            </div>
                        </div>

                        <div class="form-group mb-4">
                            <h5>Optimization Objective</h5>
                            <div class="form-check">
                                <input class="form-check-input" type="radio" name="objective" id="obj_sharpe" value="sharpe" checked>
                                <label class="form-check-label" for="obj_sharpe">
                                    <strong>Maximize Sharpe Ratio</strong> - Optimize risk-adjusted returns
                                </label>
                            </div>
                            <div class="form-check">
                                <input class="form-check-input" type="radio" name="objective" id="obj_risk" value="min_risk">
                                <label class="form-check-label" for="obj_risk">
                                    <strong>Minimize Risk</strong> - Achieve the lowest volatility possible while meeting return targets
                                </label>
                            </div>
                            <div class="form-check">
                                <input class="form-check-input" type="radio" name="objective" id="obj_return" value="max_return">
                                <label class="form-check-label" for="obj_return">
                                    <strong>Maximize Return</strong> - Aim for highest possible returns within risk constraints
                                </label>
                            </div>
                        </div>

                        <button type="submit" class="btn btn-primary">
                            <i class="fas fa-magic me-1"></i> Optimize Portfolio
                        </button>
                    </form>
                </div>
            </div>
        </div>

        <div class="col-md-4">
            <div class="card mb-4">
                <div class="card-header bg-primary text-white">
                    <h5 class="card-title mb-0">Current Portfolio</h5>
                </div>
                <div class="card-body">
                    <h6>Portfolio Value</h6>
                    <h3 class="mb-3">${{ "%.2f"|format(portfolio.stocks.total_value if portfolio.stocks.total_value else 0) }}</h3>
                    
                    <h6>Current Holdings</h6>
                    <ul class="list-group">
                        {% if portfolio.stocks and portfolio.stocks.holdings %}
                        {% for holding in portfolio.stocks.holdings %}
                        <li class="list-group-item d-flex justify-content-between align-items-center">
                            {{ holding.symbol }}
                            <span class="badge bg-primary rounded-pill">{{ "%.1f"|format(holding.weight * 100) }}%</span>
                        </li>
                        {% endfor %}
                        {% else %}
                        <li class="list-group-item">No holdings found</li>
                        {% endif %}
                    </ul>
                </div>
            </div>

            <div class="card mb-4">
                <div class="card-header bg-primary text-white">
                    <h5 class="card-title mb-0">Optimization Tips</h5>
                </div>
                <div class="card-body">
                    <ul class="list-group list-group-flush">
                        <li class="list-group-item">
                            <i class="fas fa-info-circle text-primary me-2"></i>
                            <strong>Sharpe Ratio</strong> measures risk-adjusted return. Higher is better.
                        </li>
                        <li class="list-group-item">
                            <i class="fas fa-info-circle text-primary me-2"></i>
                            <strong>Volatility</strong> measures how much returns fluctuate. Lower means more stability.
                        </li>
                        <li class="list-group-item">
                            <i class="fas fa-info-circle text-primary me-2"></i>
                            <strong>Diversification</strong> across assets helps reduce risk without sacrificing returns.
                        </li>
                        <li class="list-group-item">
                            <i class="fas fa-exclamation-triangle text-warning me-2"></i>
                            Setting unrealistic targets (too high return, too low risk) may result in no solution.
                        </li>
                    </ul>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
    document.addEventListener('DOMContentLoaded', function() {
        // Total allocation calculator
        const allocationInputs = [
            document.getElementById('equity_target'),
            document.getElementById('fixed_income_target'),
            document.getElementById('cash_target'),
            document.getElementById('alternative_target')
        ];
        
        const allocationSum = document.getElementById('allocation-sum');
        
        function updateAllocationSum() {
            let total = 0;
            allocationInputs.forEach(input => {
                total += parseInt(input.value || 0);
            });
            
            allocationSum.textContent = 'Total: ' + total + '%';
            
            if (total !== 100) {
                allocationSum.classList.add('text-danger');
                allocationSum.classList.remove('text-muted');
            } else {
                allocationSum.classList.remove('text-danger');
                allocationSum.classList.add('text-muted');
            }
        }
        
        allocationInputs.forEach(input => {
            input.addEventListener('input', updateAllocationSum);
        });
        
        // Initialize
        updateAllocationSum();
    });
</script>
{% endblock %}