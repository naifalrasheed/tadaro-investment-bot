{% extends 'base.html' %}

{% block title %}Portfolio: {{ portfolio.name }}{% endblock %}

{% block content %}
<div class="container mt-4">
    <div class="d-flex justify-content-between align-items-center mb-4">
        <h1>{{ portfolio.name }}</h1>
        <div>
            <a href="{{ url_for('portfolio_analyze', portfolio_id=portfolio.id) }}" class="btn btn-primary">
                <i class="fas fa-chart-line"></i> Analyze
            </a>
            <a href="{{ url_for('portfolio_optimize', portfolio_id=portfolio.id) }}" class="btn btn-success">
                <i class="fas fa-magic"></i> Optimize
            </a>
            <button type="button" class="btn btn-danger" data-bs-toggle="modal" data-bs-target="#deletePortfolioModal">
                <i class="fas fa-trash"></i> Delete
            </button>
        </div>
    </div>

    <div class="row">
        <!-- Portfolio Summary -->
        <div class="col-md-6">
            <div class="card mb-4">
                <div class="card-header bg-primary text-white">
                    <h5 class="card-title mb-0">Portfolio Summary</h5>
                </div>
                <div class="card-body">
                    {% if analysis and analysis.success %}
                    <div class="row">
                        <div class="col-6">
                            <h6>Total Value</h6>
                            <h3>${{ "%.2f"|format(analysis.portfolio_summary.total_value) }}</h3>
                        </div>
                        <div class="col-6">
                            <h6>Gain/Loss</h6>
                            <h3 class="{{ 'text-success' if analysis.portfolio_summary.total_gain_loss > 0 else 'text-danger' }}">
                                {{ "%.2f"|format(analysis.portfolio_summary.total_gain_loss_pct) }}%
                            </h3>
                        </div>
                    </div>
                    <hr>
                    <div class="row mt-3">
                        <div class="col-6">
                            <p><strong>Positions:</strong> {{ analysis.portfolio_summary.positions_count }}</p>
                            <p><strong>Top Concentration:</strong> {{ "%.1f"|format(analysis.portfolio_summary.top_concentration) }}%</p>
                        </div>
                        <div class="col-6">
                            <p><strong>Cost Basis:</strong> ${{ "%.2f"|format(analysis.portfolio_summary.total_cost) }}</p>
                            <p><strong>Est. Volatility:</strong> {{ "%.1f"|format(analysis.portfolio_summary.volatility_estimate) }}%</p>
                        </div>
                    </div>
                    {% else %}
                    <div class="alert alert-warning">
                        Portfolio data is not available for analysis.
                    </div>
                    {% endif %}
                </div>
            </div>
        </div>

        <!-- Asset Allocation -->
        <div class="col-md-6">
            <div class="card mb-4">
                <div class="card-header bg-primary text-white">
                    <h5 class="card-title mb-0">Asset Allocation</h5>
                </div>
                <div class="card-body">
                    {% if analysis and analysis.success and analysis.asset_allocation %}
                    <div class="chart-container" style="position: relative; height:200px;">
                        <canvas id="assetAllocationChart"></canvas>
                    </div>
                    <div class="mt-3">
                        <table class="table table-sm">
                            <thead>
                                <tr>
                                    <th>Asset Class</th>
                                    <th class="text-end">Allocation</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for asset_class, weight in analysis.asset_allocation.items() %}
                                <tr>
                                    <td>{{ asset_class }}</td>
                                    <td class="text-end">{{ "%.1f"|format(weight) }}%</td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                    {% else %}
                    <div class="alert alert-warning">
                        Asset allocation data is not available.
                    </div>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>

    <!-- Holdings Table -->
    <div class="card mb-4">
        <div class="card-header bg-primary text-white">
            <h5 class="card-title mb-0">Holdings</h5>
        </div>
        <div class="card-body">
            {% if portfolio.stocks and portfolio.stocks.holdings %}
            <div class="table-responsive">
                <table class="table table-striped table-hover">
                    <thead>
                        <tr>
                            <th>Symbol</th>
                            <th>Market</th>
                            <th>Quantity</th>
                            <th>Price</th>
                            <th>Value</th>
                            <th>Cost Basis</th>
                            <th>Gain/Loss</th>
                            <th>Weight</th>
                            <th>Sector</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for holding in portfolio.stocks.holdings %}
                        <tr>
                            {% set market = holding.market|default('US') %}
                            {% set currency = '$' if market == 'US' else 'SAR' if market == 'SAUDI' else '$' %}
                            <td>
                                {% if holding.symbol == 'CASH' %}
                                    {{ holding.symbol }}
                                {% else %}
                                    <a href="{{ url_for('naif_technical_analysis', symbol=holding.symbol, market=market|lower) }}">
                                        {{ holding.symbol }}
                                    </a>
                                {% endif %}
                            </td>
                            <td>
                                {% if holding.symbol != 'CASH' %}
                                    <span class="badge bg-primary">{{ market }}</span>
                                {% endif %}
                            </td>
                            <td>{{ holding.quantity }}</td>
                            <td>{{ currency }}{{ "%.2f"|format(holding.price|default(holding.current_price)) }}</td>
                            <td>{{ currency }}{{ "%.2f"|format(holding.position_value) }}</td>
                            <td>{{ currency }}{{ "%.2f"|format(holding.cost_basis|default(holding.position_value)) }}</td>
                            <td class="{{ 'text-success' if holding.gain_loss_pct|default(0) > 0 else 'text-danger' if holding.gain_loss_pct|default(0) < 0 else '' }}">
                                {% if holding.gain_loss_pct is defined %}
                                    {{ "%.2f"|format(holding.gain_loss_pct * 100) }}%
                                {% elif holding.yield is defined and holding.symbol == 'CASH' %}
                                    <span class="text-muted">{{ holding.yield|default(0)|round(2) }}%</span>
                                {% else %}
                                    -
                                {% endif %}
                            </td>
                            <td>{{ "%.1f"|format(holding.weight * 100) }}%</td>
                            <td>{{ holding.sector }}</td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
            
            {% if portfolio.stocks.market %}
            <div class="alert alert-info mt-3">
                <h5><i class="fas fa-info-circle"></i> Portfolio Information</h5>
                <p>This portfolio was created using the <strong>Naif Al-Rasheed Investment Model</strong> for the <strong>{{ portfolio.stocks.market }}</strong> market.</p>
                
                {% if portfolio.stocks.model == 'Naif Al-Rasheed Investment Model' %}
                    <p>The model selected {{ portfolio.stocks.positions_count }} companies from {{ portfolio.stocks.min_sectors|default(5) }}+ sectors using rigorous fundamental and technical criteria.</p>
                    
                    {% if portfolio.stocks.recommendations and portfolio.stocks.recommendations.summary %}
                        <div class="mt-2">
                            <strong>Investment Summary:</strong>
                            <p>{{ portfolio.stocks.recommendations.summary }}</p>
                        </div>
                    {% endif %}
                {% endif %}
            </div>
            {% endif %}
            
            {% else %}
            <div class="alert alert-warning">
                No holdings found in this portfolio.
            </div>
            {% endif %}
        </div>
    </div>

    <!-- Sector Allocation -->
    <div class="card mb-4">
        <div class="card-header bg-primary text-white">
            <h5 class="card-title mb-0">Sector Exposure</h5>
        </div>
        <div class="card-body">
            {% if analysis and analysis.success and analysis.sector_exposure %}
            <div class="chart-container" style="position: relative; height:300px;">
                <canvas id="sectorExposureChart"></canvas>
            </div>
            {% else %}
            <div class="alert alert-warning">
                Sector exposure data is not available.
            </div>
            {% endif %}
        </div>
    </div>

    <!-- Alignment Check -->
    {% if analysis and analysis.success and analysis.alignment %}
    <div class="card mb-4">
        <div class="card-header bg-primary text-white">
            <h5 class="card-title mb-0">Portfolio Alignment</h5>
        </div>
        <div class="card-body">
            <div class="row mb-3">
                <div class="col-md-4 text-center">
                    <div class="card h-100 {{ 'border-success' if analysis.alignment.allocation_aligned else 'border-warning' }}">
                        <div class="card-body">
                            <h5 class="card-title">Asset Allocation</h5>
                            {% if analysis.alignment.allocation_aligned %}
                            <i class="fas fa-check-circle text-success fa-3x mb-2"></i>
                            <p>Well-aligned with target allocation</p>
                            {% else %}
                            <i class="fas fa-exclamation-triangle text-warning fa-3x mb-2"></i>
                            <p>{{ analysis.alignment.allocation_misalignments|length }} misalignments detected</p>
                            {% endif %}
                        </div>
                    </div>
                </div>
                <div class="col-md-4 text-center">
                    <div class="card h-100 {{ 'border-success' if analysis.alignment.risk_aligned else 'border-warning' }}">
                        <div class="card-body">
                            <h5 class="card-title">Risk Level</h5>
                            {% if analysis.alignment.risk_aligned %}
                            <i class="fas fa-check-circle text-success fa-3x mb-2"></i>
                            <p>Risk level within target range</p>
                            {% else %}
                            <i class="fas fa-exclamation-triangle text-warning fa-3x mb-2"></i>
                            <p>{{ analysis.alignment.risk_misalignment.explanation }}</p>
                            {% endif %}
                        </div>
                    </div>
                </div>
                <div class="col-md-4 text-center">
                    <div class="card h-100 {{ 'border-success' if analysis.alignment.return_aligned else 'border-warning' }}">
                        <div class="card-body">
                            <h5 class="card-title">Expected Return</h5>
                            {% if analysis.alignment.return_aligned %}
                            <i class="fas fa-check-circle text-success fa-3x mb-2"></i>
                            <p>Expected return meets target</p>
                            {% else %}
                            <i class="fas fa-exclamation-triangle text-warning fa-3x mb-2"></i>
                            <p>{{ analysis.alignment.return_misalignment.explanation }}</p>
                            {% endif %}
                        </div>
                    </div>
                </div>
            </div>

            {% if not analysis.alignment.allocation_aligned %}
            <div class="alert alert-warning">
                <h5>Asset Allocation Misalignments:</h5>
                <ul>
                    {% for misalignment in analysis.alignment.allocation_misalignments %}
                    <li>{{ misalignment.explanation }}</li>
                    {% endfor %}
                </ul>
                <a href="{{ url_for('portfolio_analyze', portfolio_id=portfolio.id) }}" class="btn btn-sm btn-primary">Get Rebalancing Suggestions</a>
            </div>
            {% endif %}
        </div>
    </div>
    {% endif %}
    
    <!-- Monte Carlo Simulation -->
    {% if portfolio.stocks.simulation_results and portfolio.stocks.simulation_results.success %}
    <div class="card mb-4">
        <div class="card-header bg-primary text-white">
            <h5 class="card-title mb-0">Monte Carlo Simulation</h5>
        </div>
        <div class="card-body">
            <div class="row">
                <div class="col-md-4">
                    <div class="card">
                        <div class="card-header bg-light">
                            <h6 class="mb-0">Simulation Results</h6>
                        </div>
                        <div class="card-body">
                            <table class="table table-sm">
                                <tbody>
                                    <tr>
                                        <th>Time Horizon</th>
                                        <td>{{ portfolio.stocks.simulation_results.time_horizon_years }} years</td>
                                    </tr>
                                    <tr>
                                        <th>Expected Annual Return</th>
                                        <td>{{ portfolio.stocks.simulation_results.adjusted_annual_return|round(2) }}%</td>
                                    </tr>
                                    <tr>
                                        <th>Volatility</th>
                                        <td>{{ portfolio.stocks.simulation_results.portfolio_volatility|round(2) }}%</td>
                                    </tr>
                                    <tr>
                                        <th>Loss Probability</th>
                                        <td>{{ portfolio.stocks.simulation_results.loss_probability|round(2) }}%</td>
                                    </tr>
                                    <tr>
                                        <th>Value at Risk (95%)</th>
                                        <td>{{ portfolio.stocks.simulation_results.adjusted_var_95|round(2) }}%</td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
                <div class="col-md-8">
                    {% if portfolio.stocks.visualizations and portfolio.stocks.visualizations.monte_carlo_simulation %}
                    <img src="data:image/png;base64,{{ portfolio.stocks.visualizations.monte_carlo_simulation }}" 
                         class="img-fluid" alt="Monte Carlo Simulation">
                    {% else %}
                    <div class="alert alert-info">
                        <p>Monte Carlo simulation run with {{ portfolio.stocks.simulation_results.num_simulations }} iterations. Final value ranges from 
                           {{ portfolio.stocks.simulation_results.final_value_statistics.min|round(2) }} to 
                           {{ portfolio.stocks.simulation_results.final_value_statistics.max|round(2) }}
                           (starting from 1.0).</p>
                    </div>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>
    {% endif %}
</div>

<!-- Delete Portfolio Modal -->
<div class="modal fade" id="deletePortfolioModal" tabindex="-1" aria-labelledby="deletePortfolioModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="deletePortfolioModalLabel">Confirm Deletion</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                Are you sure you want to delete the portfolio <strong>{{ portfolio.name }}</strong>? This action cannot be undone.
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <form action="{{ url_for('portfolio_delete', portfolio_id=portfolio.id) }}" method="post">
                    <button type="submit" class="btn btn-danger">Delete Portfolio</button>
                </form>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
    document.addEventListener('DOMContentLoaded', function() {
        {% if analysis and analysis.success and analysis.asset_allocation %}
        // Asset Allocation Chart
        const assetAllocationCtx = document.getElementById('assetAllocationChart').getContext('2d');
        const assetAllocationLabels = [{% for asset_class in analysis.asset_allocation.keys() %}'{{ asset_class }}',{% endfor %}];
        const assetAllocationData = [{% for weight in analysis.asset_allocation.values() %}{{ weight }},{% endfor %}];
        const assetAllocationColors = [
            'rgba(54, 162, 235, 0.8)',
            'rgba(255, 99, 132, 0.8)',
            'rgba(255, 206, 86, 0.8)',
            'rgba(75, 192, 192, 0.8)',
            'rgba(153, 102, 255, 0.8)',
            'rgba(255, 159, 64, 0.8)',
            'rgba(199, 199, 199, 0.8)'
        ];

        new Chart(assetAllocationCtx, {
            type: 'pie',
            data: {
                labels: assetAllocationLabels,
                datasets: [{
                    label: 'Asset Allocation',
                    data: assetAllocationData,
                    backgroundColor: assetAllocationColors,
                    borderWidth: 1
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: {
                        position: 'right',
                    }
                }
            }
        });
        {% endif %}

        {% if analysis and analysis.success and analysis.sector_exposure %}
        // Sector Exposure Chart
        const sectorExposureCtx = document.getElementById('sectorExposureChart').getContext('2d');
        const sectorExposureLabels = [{% for sector in analysis.sector_exposure.keys() %}'{{ sector }}',{% endfor %}];
        const sectorExposureData = [{% for weight in analysis.sector_exposure.values() %}{{ weight }},{% endfor %}];
        const sectorExposureColors = [
            'rgba(54, 162, 235, 0.8)',
            'rgba(255, 99, 132, 0.8)',
            'rgba(255, 206, 86, 0.8)',
            'rgba(75, 192, 192, 0.8)',
            'rgba(153, 102, 255, 0.8)',
            'rgba(255, 159, 64, 0.8)',
            'rgba(199, 199, 199, 0.8)',
            'rgba(83, 123, 196, 0.8)',
            'rgba(172, 114, 94, 0.8)',
            'rgba(99, 201, 122, 0.8)',
            'rgba(201, 99, 174, 0.8)',
            'rgba(205, 190, 84, 0.8)'
        ];

        new Chart(sectorExposureCtx, {
            type: 'bar',
            data: {
                labels: sectorExposureLabels,
                datasets: [{
                    label: 'Sector Exposure (%)',
                    data: sectorExposureData,
                    backgroundColor: sectorExposureColors,
                    borderWidth: 1
                }]
            },
            options: {
                indexAxis: 'y',
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: {
                        display: false
                    }
                },
                scales: {
                    x: {
                        beginAtZero: true,
                        title: {
                            display: true,
                            text: 'Allocation (%)'
                        }
                    }
                }
            }
        });
        {% endif %}
    });
</script>
{% endblock %}